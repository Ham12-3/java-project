databaseChangeLog:
  - changeSet:
      id: add-password-reset-table
      author: you
      changes:
        - createTable:
            tableName: password_reset_tokens
            columns:
              - column:
                  name: id
                  type: BIGINT GENERATED BY DEFAULT AS IDENTITY
                  constraints:
                    primaryKey: true
              - column:
                  name: user_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: token
                  type: VARCHAR2(255)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: expires_at
                  type: TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: used
                  type: NUMBER(1)
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: password_reset_tokens
            baseColumnNames: user_id
            referencedTableName: auth_users
            referencedColumnNames: id
            constraintName: fk_reset_user

  - changeSet:
      id: password-reset-timestamptz
      author: you
      changes:
        - addColumn:
            tableName: password_reset_tokens
            columns:
              - column:
                  name: expires_at_tz
                  type: "TIMESTAMP WITH TIME ZONE"
        - sql: >
            UPDATE password_reset_tokens
            SET expires_at_tz = FROM_TZ(expires_at, 'UTC')
        - dropColumn:
            tableName: password_reset_tokens
            columnName: expires_at
        - renameColumn:
            tableName: password_reset_tokens
            oldColumnName: expires_at_tz
            newColumnName: expires_at
        - addColumn:
            tableName: auth_users
            columns:
              - column:
                  name: created_at_tz
                  type: "TIMESTAMP WITH TIME ZONE"
        - sql: >
            UPDATE auth_users
            SET created_at_tz = FROM_TZ(created_at, 'UTC')
        - dropColumn:
            tableName: auth_users
            columnName: created_at
        - renameColumn:
            tableName: auth_users
            oldColumnName: created_at_tz
            newColumnName: created_at

  - changeSet:
      id: add-customers-table
      author: you
      changes:
        - createTable:
            tableName: customers
            columns:
              - column:
                  name: id
                  type: BIGINT GENERATED BY DEFAULT AS IDENTITY
                  constraints:
                    primaryKey: true
              - column:
                  name: full_name
                  type: VARCHAR2(150)
                  constraints:
                    nullable: false
              - column:
                  name: email
                  type: VARCHAR2(255)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: notes
                  type: VARCHAR2(500)
              - column:
                  name: status
                  type: VARCHAR2(32)
                  defaultValue: PENDING
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: "TIMESTAMP WITH TIME ZONE"
                  defaultValueComputed: SYSTIMESTAMP
                  constraints:
                    nullable: false

  - changeSet:
      id: add-customer-profile-tables
      author: codex
      changes:
        - createTable:
            tableName: customer_profiles
            columns:
              - column:
                  name: id
                  type: BIGINT GENERATED BY DEFAULT AS IDENTITY
                  constraints:
                    primaryKey: true
              - column:
                  name: customer_id
                  type: BIGINT
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: company_name
                  type: VARCHAR2(255)
              - column:
                  name: country
                  type: VARCHAR2(100)
              - column:
                  name: industry
                  type: VARCHAR2(150)
              - column:
                  name: risk_score
                  type: NUMBER(5,2)
              - column:
                  name: verification_status
                  type: VARCHAR2(32)
                  defaultValue: NOT_STARTED
                  constraints:
                    nullable: false
              - column:
                  name: notes
                  type: VARCHAR2(1000)
              - column:
                  name: submitted_at
                  type: "TIMESTAMP WITH TIME ZONE"
              - column:
                  name: approved_at
                  type: "TIMESTAMP WITH TIME ZONE"
              - column:
                  name: created_at
                  type: "TIMESTAMP WITH TIME ZONE"
                  defaultValueComputed: SYSTIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: "TIMESTAMP WITH TIME ZONE"
                  defaultValueComputed: SYSTIMESTAMP
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: customer_profiles
            baseColumnNames: customer_id
            constraintName: fk_profile_customer
            referencedTableName: customers
            referencedColumnNames: id
        - createTable:
            tableName: customer_documents
            columns:
              - column:
                  name: id
                  type: BIGINT GENERATED BY DEFAULT AS IDENTITY
                  constraints:
                    primaryKey: true
              - column:
                  name: profile_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: doc_name
                  type: VARCHAR2(255)
                  constraints:
                    nullable: false
              - column:
                  name: doc_type
                  type: VARCHAR2(100)
              - column:
                  name: doc_url
                  type: VARCHAR2(500)
              - column:
                  name: status
                  type: VARCHAR2(32)
                  constraints:
                    nullable: false
              - column:
                  name: uploaded_at
                  type: "TIMESTAMP WITH TIME ZONE"
                  defaultValueComputed: SYSTIMESTAMP
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: customer_documents
            baseColumnNames: profile_id
            constraintName: fk_documents_profile
            referencedTableName: customer_profiles
            referencedColumnNames: id
        - createTable:
            tableName: customer_audit_log
            columns:
              - column:
                  name: id
                  type: BIGINT GENERATED BY DEFAULT AS IDENTITY
                  constraints:
                    primaryKey: true
              - column:
                  name: profile_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: action
                  type: VARCHAR2(100)
                  constraints:
                    nullable: false
              - column:
                  name: actor
                  type: VARCHAR2(100)
              - column:
                  name: notes
                  type: VARCHAR2(1000)
              - column:
                  name: created_at
                  type: "TIMESTAMP WITH TIME ZONE"
                  defaultValueComputed: SYSTIMESTAMP
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: customer_audit_log
            baseColumnNames: profile_id
            constraintName: fk_audit_profile
            referencedTableName: customer_profiles
            referencedColumnNames: id
  - changeSet:
      id: add-customer-auth-link
      author: codex
      changes:
        - addColumn:
            tableName: customers
            columns:
              - column:
                  name: auth_user_id
                  type: BIGINT
        - addForeignKeyConstraint:
            baseTableName: customers
            baseColumnNames: auth_user_id
            referencedTableName: auth_users
            referencedColumnNames: id
            constraintName: fk_customer_auth_user

  - changeSet:
      id: extend-customer-documents-content
      author: codex
      changes:
        - addColumn:
            tableName: customer_documents
            columns:
              - column:
                  name: content_type
                  type: VARCHAR2(120)
              - column:
                  name: file_data
                  type: BLOB

  - changeSet:
      id: create-customer-accounts
      author: codex
      changes:
        - createTable:
            tableName: customer_accounts
            columns:
              - column:
                  name: id
                  type: BIGINT GENERATED BY DEFAULT AS IDENTITY
                  constraints:
                    primaryKey: true
              - column:
                  name: customer_id
                  type: BIGINT
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: account_number
                  type: VARCHAR2(20)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: sort_code
                  type: VARCHAR2(8)
                  constraints:
                    nullable: false
              - column:
                  name: balance
                  type: NUMBER(19,2)
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
              - column:
                  name: overdraft_limit
                  type: NUMBER(19,2)
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
              - column:
                  name: currency
                  type: VARCHAR2(16)
                  defaultValue: GBP
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: "TIMESTAMP WITH TIME ZONE"
                  defaultValueComputed: SYSTIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: "TIMESTAMP WITH TIME ZONE"
                  defaultValueComputed: SYSTIMESTAMP
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: customer_accounts
            baseColumnNames: customer_id
            referencedTableName: customers
            referencedColumnNames: id
            constraintName: fk_account_customer
        - createTable:
            tableName: account_transactions
            columns:
              - column:
                  name: id
                  type: BIGINT GENERATED BY DEFAULT AS IDENTITY
                  constraints:
                    primaryKey: true
              - column:
                  name: account_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: transaction_type
                  type: VARCHAR2(20)
                  constraints:
                    nullable: false
              - column:
                  name: amount
                  type: NUMBER(19,2)
                  constraints:
                    nullable: false
              - column:
                  name: currency
                  type: VARCHAR2(16)
                  defaultValue: GBP
                  constraints:
                    nullable: false
              - column:
                  name: counterparty
                  type: VARCHAR2(255)
              - column:
                  name: reference
                  type: VARCHAR2(100)
              - column:
                  name: description
                  type: VARCHAR2(500)
              - column:
                  name: balance_after
                  type: NUMBER(19,2)
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: "TIMESTAMP WITH TIME ZONE"
                  defaultValueComputed: SYSTIMESTAMP
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: account_transactions
            baseColumnNames: account_id
            referencedTableName: customer_accounts
            referencedColumnNames: id
            constraintName: fk_transaction_account
        - createIndex:
            tableName: account_transactions
            indexName: idx_transactions_account_created
            columns:
              - column:
                  name: account_id
              - column:
                  name: created_at

  - changeSet:
      id: create-email-mfa-challenges
      author: codex
      changes:
        - createTable:
            tableName: email_mfa_challenges
            columns:
              - column:
                  name: id
                  type: BIGINT GENERATED BY DEFAULT AS IDENTITY
                  constraints:
                    primaryKey: true
              - column:
                  name: username
                  type: VARCHAR2(100)
                  constraints:
                    nullable: false
              - column:
                  name: code_hash
                  type: VARCHAR2(255)
                  constraints:
                    nullable: false
              - column:
                  name: expires_at
                  type: "TIMESTAMP WITH TIME ZONE"
                  constraints:
                    nullable: false
              - column:
                  name: consumed_at
                  type: "TIMESTAMP WITH TIME ZONE"
              - column:
                  name: created_at
                  type: "TIMESTAMP WITH TIME ZONE"
                  defaultValueComputed: SYSTIMESTAMP
                  constraints:
                    nullable: false
